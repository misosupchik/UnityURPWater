# UnityURPWater





Основные требования:

* 1 draw call для воды (т.е. 1 материал и 1 меш)
* urp, для мобильных устройств
* глубина
* vertex displacement
* взаимодействие с поверхностью воды (пена)
* след при движении



##### Глубина



Основной момент в реализации этого требования - вычисления непосредственно глубины. Есть два варианта достижения эффекта, которые можно условно обозвать как **eye depth** и **world-space depth**. 

В первом случае вычисляется расстояние от камеры до поверхности объекта. Это реализуется довольно просто, с минимум вычислений. Однако определённые искажения при изменении угла камеры неизбежны.

Второй способ несколько сложнее и требует дополнительных вычислений касательно Scene Position.

Так как шейдер предполагается как мобильный, и для упрощения самого графа, искажениями можно пренебречь и использовать первый вариант.



По схожему принципу работает Fresnel Effect, с помощью которого можно изменить цвет поверхности воды на некотором расстоянии от камеры (в зависимости от угла, опять же).





##### Волны (Vertex Displacement)



Во избежание слишком тяжёлых вычислений, применён самый простой способ - с помощью текстуры шума. Добавив ее к Position, можно получить карту высот для вертексов.





##### Пена



Продублировав уже реализованный Intersection и применив к нему желаемую текстуру, получаем пену на пересечении объектов с водой.

А через Position можно получить высоту вертексов. Задав минимальную высоту параметром, к полученной область применяем ту же текстуру. Так получаем пену на гребнях волн.





##### Refraction



Искажения под поверхностью воды добавлены для наглядности. Эту фичу не рекомендуется использовать на мобилках.





##### След при движении



Есть несколько вариантов реализации: через vfx (particle system / vfx graph), декалями или с помощью render texture. Поскольку вода имеет волны, vfx отпадает, т.к. велика вероятность, что пактиклы окажутся под водой. Декали в urp на прозрачной поверхности отрисовывать невозможно (однако такая фича доступна в hdrp). Таким образом остаётся только вариант с render texture.
Для простоты rt прокинут напрямую в шейдер. Рендерится только определённый слой, на котором находится partical system с трейлом. К полученной текстуре применяется текстура пены.
Минусы: эффект происходит вне зависимости от положения объекта по высоте относительно воды. Это можно исправить двумя способами: дублирование меша с шейдером, использующим такой же vertex displacement, который будет выступать в качестве маски для render texture; создание математической модели vertex displacement в скрипте и вычисление позиции объекта относительно этой модели (для верности стоит также использовать математическую модель волн в шейдере, но для упрощения шейдера - не реализовано), что также будет полезно для floating-системы в дальнейшем.







###### Основные параметры шейдера:



* GenegalTimeMultiplier - скорость всей анимации воды

Colors

* DepthColor - цвет воды на глубине
* SurfaceColor - цвет на поверхности
* DistanceColor - цвет "горизонта" (Fresnel)
* FoamColor - цвет пены

Depth

* DepthPower - глубина
* FresnelPower - дистанция "горизонта"

Normals

* Smoothness - сила бликов
* NormalTexture - карта нормалей
* NormalTiling - размер карты
* NormalSpeed - скорость и направление движения
* NormalStrength - сила нормалей

Waves

* WavesNoiseTiling - размер текстуры волн (vertex displacement)
* WavesNoiseSpeed - скорость и направление движения
* WavesHeight - высота волн
* WavesStrength - баланс белого текстуры

Foam

* FoamNoiseTexture - текстура пены
* FoamTextureTiling - размер текстуры
* FoamTextureSpeed - скорость и направление движения
* FoamDepthOffset - отступ
* FoamDistance - размер применяемой области
* FoamAmount - плотность пены

HighFoam

* WaveFoamPower - плотность пены на волнах
* WaveFoamHeight - с какой высоты волн появляется пена
* WaveFoamTransparency - прозрачность пены

Refraction

* RefractionSwitch - вкл/выкл эффекта
* RefractionStrength - сила эффекта (distortion)

Trails

* TrailRenderTexture - ссылка на render texture
